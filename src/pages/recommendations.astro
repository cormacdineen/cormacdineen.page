---
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import recommendations from "@/data/recommendations.json";

const categories = ["all", "book", "podcast", "movie", "tv", "sport", "food"] as const;

const categoryLabels: Record<string, string> = {
  all: "All",
  book: "Books",
  podcast: "Podcasts",
  movie: "Movies",
  tv: "TV",
  sport: "Live Sport",
  food: "Food",
};

// Collect all unique tags from the data
const allTags = [...new Set(recommendations.flatMap((item) => item.tags || []))].sort();
---

<Layout title={`Cultural Stew | ${SITE.title}`} description="Books, podcasts, films, TV, sport, and food recommended by Cormac Dineen.">
  <Header />
  <main id="main-content" class="mx-auto w-full max-w-3xl px-4 pb-12">
    <h1 class="text-2xl font-semibold sm:text-3xl mt-8">Cultural Stew</h1>
    <p class="mt-2 mb-6 italic">Frivilous pursuits are the only thing that distinguish our lives from those of jellyfish.</p>

    <!-- Category filter tabs -->
    <div class="flex gap-2 mb-4 flex-wrap">
      {categories.map((cat) => (
        <button
          class:list={[
            "filter-btn px-4 py-1.5 rounded-full text-sm font-medium border transition-colors cursor-pointer",
            cat === "all"
              ? "bg-accent text-white border-accent"
              : "bg-transparent text-foreground border-border hover:border-accent",
          ]}
          data-filter={cat}
        >
          {categoryLabels[cat]}
        </button>
      ))}
    </div>

    <!-- Tag filter pills -->
    {allTags.length > 0 && (
      <div class="flex gap-1.5 mb-8 flex-wrap items-center">
        <span class="text-xs text-foreground/50 mr-1">Tags:</span>
        {allTags.map((tag) => (
          <button
            class="tag-btn px-2.5 py-0.5 rounded-full text-xs border border-border text-foreground/70 hover:border-accent hover:text-accent transition-colors cursor-pointer bg-transparent"
            data-tag={tag}
          >
            {tag}
          </button>
        ))}
      </div>
    )}

    <!-- Grid of cards -->
    <div id="rec-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {recommendations.map((item) => (
        <div
          class="rec-card border border-border rounded-lg overflow-hidden"
          data-type={item.type}
          data-tags={(item.tags || []).join(",")}
        >
          <img
            src={item.cover}
            alt={item.title}
            class="w-full h-48 object-cover"
            loading="lazy"
          />
          <div class="p-3">
            <span class="text-xs uppercase tracking-wide text-accent font-medium">{item.type}</span>
            <h3 class="font-semibold mt-1">{item.title}</h3>
            <p class="text-sm text-foreground/60">{item.creator}</p>
            <p class="text-sm mt-2">{item.note}</p>
            {item.tags && item.tags.length > 0 && (
              <div class="flex gap-1 mt-2 flex-wrap">
                {item.tags.map((tag: string) => (
                  <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-muted text-foreground/60">{tag}</span>
                ))}
              </div>
            )}
          </div>
        </div>
      ))}
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline>
  document.addEventListener("astro:page-load", () => {
    const categoryButtons = document.querySelectorAll(".filter-btn");
    const tagButtons = document.querySelectorAll(".tag-btn");
    const cards = document.querySelectorAll(".rec-card");

    let activeCategory = "all";
    let activeTags = new Set();

    function applyFilters() {
      cards.forEach((card) => {
        const cardType = card.dataset.type;
        const cardTags = card.dataset.tags ? card.dataset.tags.split(",") : [];

        const matchesCategory = activeCategory === "all" || cardType === activeCategory;
        const matchesTags = activeTags.size === 0 || cardTags.some((t) => activeTags.has(t));

        card.style.display = matchesCategory && matchesTags ? "" : "none";
      });
    }

    // Category filter — mutually exclusive
    categoryButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        activeCategory = btn.dataset.filter;

        categoryButtons.forEach((b) => {
          b.classList.remove("bg-accent", "text-white", "border-accent");
          b.classList.add("bg-transparent", "text-foreground", "border-border");
        });
        btn.classList.add("bg-accent", "text-white", "border-accent");
        btn.classList.remove("bg-transparent", "text-foreground", "border-border");

        applyFilters();
      });
    });

    // Tag filter — toggle on/off (additive)
    tagButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tag = btn.dataset.tag;

        if (activeTags.has(tag)) {
          activeTags.delete(tag);
          btn.classList.remove("bg-accent", "text-white", "border-accent");
          btn.classList.add("border-border", "text-foreground/70");
        } else {
          activeTags.add(tag);
          btn.classList.add("bg-accent", "text-white", "border-accent");
          btn.classList.remove("border-border", "text-foreground/70");
        }

        applyFilters();
      });
    });
  });
</script>
